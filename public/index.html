<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP 状态监控</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 0;
            background-color: #f0f0f0;
            min-height: 100vh;
            position: relative;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            position: relative;
        }

        .add-ip-drawer {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100%;
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 100vh;
        }

        .add-ip-drawer.open {
            left: 0;
        }

        .add-ip-toggle {
            position: fixed;
            top: 50%;
            left: 2px;
            transform: translateY(-50%);
            background-color: #0075CF;
            color: white;
            border: none;
            padding: 5px 2px;
            cursor: pointer;
            font-size: 18px;
            z-index: 1001;
            border-radius: 0 5px 5px 0;
            transition: background-color 0.2s;
        }

        .add-ip-toggle:hover {
            background-color: #005B9F;
        }

        .form-container {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            background-color: #fff;
        }

        .form-container input,
        .form-container select {
            padding: 5px;
            margin-right: 10px;
            width: calc(100% - 15px);
            margin-bottom: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            /* 按钮间距 */
            justify-content: space-between;
            /* 按钮均匀分布 */
            margin-top: 10px;
            /* 与上方输入框的间距 */
        }

        .form-container button {
            padding: 5px 10px;
            background-color: #0075CF;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            border-radius: 5px;
            transition: background-color 0.2s;
            width: 100%;
        }

        .form-container button:hover {
            background-color: #005B9F;
        }

        .form-container button.delete {
            background-color: #F44336;
        }

        .form-container button.delete:hover {
            background-color: #D32F2F;
        }

        .form-container button.loading {
            position: relative;
            cursor: not-allowed;
            opacity: 0.8;
            background-color: #0075CF;
            padding-left: 40px;
        }

        .form-container button.loading::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: translateY(-50%) rotate(0deg);
            }

            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        .status-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 1200px;
            height: 500px;
            background-color: rgba(128, 128, 128, 0.3);
            border: 2px dashed #888;
            border-radius: 10px;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .title-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: #000;
            display: flex;
            align-items: center;
            padding: 0 10px;
            box-sizing: border-box;
            z-index: 2;
            color: white;
        }

        .title-text {
            flex: 0 0 auto;
            font-size: 16px;
            margin-right: 20px;
        }

        .status-indicators {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .indicator-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .indicator-color.grey {
            background-color: #B0BEC5;
        }

        .indicator-color.blue {
            background-color: #2196F3;
        }

        .indicator-color.red {
            background-color: #F44336;
        }

        .indicator-text {
            font-size: 14px;
            color: white;
        }

        /* 新增：数字样式 */
        .count-idle {
            font-size: 16px;
            /* 比文本大一号 */
            color: #15f62f;
            /* 灰色 */
        }

        .count-in-use {
            font-size: 16px;
            color: #2196F3;
            /* 蓝色 */
        }

        .count-repairing {
            font-size: 16px;
            color: #F44336;
            /* 红色 */
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 8px;
            background-color: #4CAF50;
            cursor: se-resize;
            z-index: 3;
        }

        .status-block {
            width: 150px;
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.5s;
            color: white;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            position: absolute;
            cursor: move;
            user-select: none;
            z-index: 1;
            overflow: hidden;
            top: 40px;
        }

        .block-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 5px;
            height: 6px;
            background-color: #ff9800;
            cursor: se-resize;
            z-index: 3;
        }

        .online {
            background-color: #2196F3;
        }

        .offline {
            background-color: #B0BEC5;
        }

        .repairing {
            background-color: #F44336;
        }

        .status-block p {
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="status-container" id="statusContainer">
            <div class="title-bar" id="titleBar">
                <div class="title-text" id="titleText">默认标题</div>
                <div class="status-indicators">
                    <div class="indicator">
                        <div class="indicator-color grey"></div>
                        <span class="indicator-text" id="idleCount">空闲中 0</span>
                    </div>
                    <div class="indicator">
                        <div class="indicator-color blue"></div>
                        <span class="indicator-text" id="inUseCount">使用中 0</span>
                    </div>
                    <div class="indicator">
                        <div class="indicator-color red"></div>
                        <span class="indicator-text" id="repairingCount">维修中 0</span>
                    </div>
                </div>
            </div>
            <div class="resize-handle" id="resizeHandle"></div>
        </div>
    </div>
    <div class="add-ip-drawer" id="addIpDrawer">
        <h1>IP 状态检测</h1>
        <div class="form-container">
            <h2>设置标题</h2>
            <input type="text" id="titleInput" placeholder="输入标题">
            <button onclick="setTitle()">应用标题</button>
        </div>
        <div class="form-container">
            <h2>添加 IP</h2>
            <input type="text" id="ipInput" placeholder="IP 地址 (如 192.168.137.1)">
            <input type="text" id="numberInput" placeholder="编号 (如 PC01)">
            <button onclick="addIp()">添加 IP</button>
        </div>
        <div class="form-container">
            <h2>已添加的 IP 列表</h2>
            <div id="ipList" style="max-height: 150px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">IP 地址</th>
                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">编号</th>
                        </tr>
                    </thead>
                    <tbody id="ipListBody"></tbody>
                </table>
            </div>
        </div>
        <div class="form-container">
            <h2>删除 IP</h2>
            <input type="text" id="deleteIpInput" placeholder="输入 IP (如 192.168.137.1)">
            <button class="delete" onclick="deleteIp()">删除 IP</button>
        </div>
        <div class="form-container">
            <h2>设置背景图</h2>
            <input type="file" id="backgroundImageInput" accept="image/*">
            <div class="button-group">
                <button onclick="setBackgroundImage()">应用背景图</button>
                <button onclick="removeBackgroundImage()">移除背景图</button>
            </div>
        </div>
        <div class="form-container">
            <h2>设置 IP 状态</h2>
            <input type="text" id="setStatusIpInput" placeholder="输入 IP">
            <select id="statusSelect">
                <option value="0">空闲中</option>
                <option value="1">使用中</option>
                <option value="2">维修中</option>
            </select>
            <button onclick="setIpStatus()">设置状态</button>
        </div>
    </div>
    <button class="add-ip-toggle" id="addIpToggle" onclick="toggleAddIpDrawer()">></button>

    <script>
        function toggleAddIpDrawer() {
            const drawer = document.getElementById('addIpDrawer');
            const toggleButton = document.getElementById('addIpToggle');
            const isOpen = drawer.classList.contains('open');

            if (isOpen) {
                drawer.classList.remove('open');
                toggleButton.innerHTML = '>';
            } else {
                drawer.classList.add('open');
                toggleButton.innerHTML = '<';
            }
        }

        async function addIp() {
            const ip = document.getElementById('ipInput').value.trim();
            const number = document.getElementById('numberInput').value.trim();

            if (!ip || !number) {
                alert('IP 和编号不能为空');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/add-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip, number }),
                });
                const result = await response.json();

                if (response.ok) {
                    alert('IP 添加成功');
                    document.getElementById('ipInput').value = '';
                    document.getElementById('numberInput').value = '';
                    fetchStatus();
                    updateIpList();
                    toggleAddIpDrawer();
                } else {
                    alert(`添加失败: ${result.error}`);
                }
            } catch (error) {
                console.error('添加 IP 失败:', error);
                alert('添加 IP 失败');
            }
        }

        async function deleteIp() {
            const ip = document.getElementById('deleteIpInput').value.trim();

            if (!ip) {
                alert('IP 不能为空');
                return;
            }

            console.log(`尝试删除 IP ${ip}`);
            try {
                const response = await fetch('http://localhost:3000/delete-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip }),
                });
                const result = await response.json();

                console.log('后端响应:', result);
                if (response.ok) {
                    alert('IP 删除成功');
                    document.getElementById('deleteIpInput').value = '';
                    await fetchStatus();
                    updateIpList();
                } else {
                    alert(`删除失败: ${result.error}`);
                }
            } catch (error) {
                console.error('删除 IP 失败:', error);
                alert('删除 IP 失败');
            }
        }

        function setTitle() {
            const titleInput = document.getElementById('titleInput');
            const titleText = document.getElementById('titleText');
            const title = titleInput.value.trim();

            if (!title) {
                alert('标题不能为空');
                return;
            }

            titleText.textContent = title;
            localStorage.setItem('containerTitle', title);
            titleInput.value = '';
        }

        function loadTitle() {
            const titleText = document.getElementById('titleText');
            const savedTitle = localStorage.getItem('containerTitle');
            if (savedTitle) {
                titleText.textContent = savedTitle;
            }
        }

        function setBackgroundImage() {
            const input = document.getElementById('backgroundImageInput');
            const container = document.getElementById('statusContainer');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    const imageUrl = e.target.result;
                    container.style.backgroundImage = `url(${imageUrl})`;
                    localStorage.setItem('backgroundImage', imageUrl);
                };

                reader.readAsDataURL(file);
            } else {
                alert('请选择一张图片');
            }
        }

        function removeBackgroundImage() {
            const container = document.getElementById('statusContainer');
            container.style.backgroundImage = 'none';
            localStorage.removeItem('backgroundImage');
        }

        function loadBackgroundImage() {
            const container = document.getElementById('statusContainer');
            const savedImage = localStorage.getItem('backgroundImage');
            if (savedImage) {
                container.style.backgroundImage = `url(${savedImage})`;
            }
        }

        async function setIpStatus() {
            const ip = document.getElementById('setStatusIpInput').value.trim();
            const status = parseInt(document.getElementById('statusSelect').value);
            const button = document.querySelector('#addIpDrawer .form-container button[onclick="setIpStatus()"]');

            if (!ip) {
                alert('IP 不能为空');
                return;
            }

            button.classList.add('loading');
            button.disabled = true;
            button.textContent = '设置中...';

            console.log(`尝试设置 IP ${ip} 的状态为 ${status}`);
            try {
                const response = await fetch('http://localhost:3000/set-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip, status }),
                });
                const result = await response.json();

                console.log('后端响应:', result);
                if (response.ok) {
                    alert('状态设置成功');
                    document.getElementById('setStatusIpInput').value = '';
                    await fetchStatus();
                } else {
                    alert(`设置状态失败: ${result.error}`);
                }
            } catch (error) {
                console.error('设置状态失败:', error);
                alert('设置状态失败');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
                button.textContent = '设置状态';
            }
        }

        function makeDraggable(element, ip) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;

            element.addEventListener('mousedown', startDragging);

            function startDragging(e) {
                if (e.target.classList.contains('block-resize-handle')) return;

                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;

                isDragging = true;

                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDragging);
            }

            async function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    const container = document.getElementById('statusContainer');
                    const rect = container.getBoundingClientRect();
                    const blockWidth = element.offsetWidth;
                    const blockHeight = element.offsetHeight;

                    currentX = Math.max(0, Math.min(currentX, rect.width - blockWidth));
                    currentY = Math.max(40, Math.min(currentY, rect.height - blockHeight));

                    element.style.left = `${currentX}px`;
                    element.style.top = `${currentY}px`;
                }
            }

            async function stopDragging() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDragging);

                try {
                    await fetch('http://localhost:3000/update-position', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ip: ip,
                            position_x: currentX,
                            position_y: currentY
                        }),
                    });
                } catch (error) {
                    console.error('保存位置失败:', error);
                }
            }

            currentX = element.offsetLeft || 0;
            currentY = element.offsetTop || 40;
            element.style.left = `${currentX}px`;
            element.style.top = `${currentY}px`;
        }

        function makeBlockResizable(block, ip) {
            const resizeHandle = block.querySelector('.block-resize-handle');
            let isResizing = false;
            let startX;
            let startY;
            let startWidth;
            let startHeight;

            resizeHandle.addEventListener('mousedown', startResizing);

            function startResizing(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(getComputedStyle(block).width, 10);
                startHeight = parseInt(getComputedStyle(block).height, 10);

                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResizing);
            }

            function resize(e) {
                if (isResizing) {
                    e.preventDefault();

                    const newWidth = startWidth + (e.clientX - startX);
                    const newHeight = startHeight + (e.clientY - startY);

                    block.style.width = `${Math.max(30, newWidth)}px`;
                    block.style.height = `${Math.max(20, newHeight)}px`;

                    const container = document.getElementById('statusContainer');
                    const rect = container.getBoundingClientRect();
                    const blockLeft = parseInt(block.style.left, 10);
                    const blockTop = parseInt(block.style.top, 10);

                    block.style.left = `${Math.min(blockLeft, rect.width - newWidth)}px`;
                    block.style.top = `${Math.min(blockTop, rect.height - newHeight)}px`;
                }
            }

            async function stopResizing() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResizing);

                try {
                    const newWidth = parseInt(block.style.width, 10);
                    const newHeight = parseInt(block.style.height, 10);
                    await fetch('http://localhost:3000/update-size', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ip: ip,
                            width: newWidth,
                            height: newHeight
                        }),
                    });
                } catch (error) {
                    console.error('保存块尺寸失败:', error);
                }
            }
        }

        function makeResizable() {
            const container = document.getElementById('statusContainer');
            const resizeHandle = document.getElementById('resizeHandle');
            let isResizing = false;
            let startX;
            let startY;
            let startWidth;
            let startHeight;

            resizeHandle.addEventListener('mousedown', startResizing);

            function startResizing(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(getComputedStyle(container).width, 10);
                startHeight = parseInt(getComputedStyle(container).height, 10);

                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResizing);
            }

            function resize(e) {
                if (isResizing) {
                    e.preventDefault();

                    const newWidth = startWidth + (e.clientX - startX);
                    const newHeight = startHeight + (e.clientY - startY);

                    container.style.width = `${Math.max(300, newWidth)}px`;
                    container.style.height = `${Math.max(300, newHeight)}px`;

                    const blocks = document.querySelectorAll('.status-block');
                    blocks.forEach(block => {
                        const blockLeft = parseInt(block.style.left, 10);
                        const blockTop = parseInt(block.style.top, 10);
                        const blockWidth = block.offsetWidth;
                        const blockHeight = block.offsetHeight;

                        block.style.left = `${Math.min(blockLeft, newWidth - blockWidth)}px`;
                        block.style.top = `${Math.min(blockTop, newHeight - blockHeight)}px`;
                    });
                }
            }

            function stopResizing() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResizing);
            }
        }

        function updateStatusCounts(statusList) {
            const idleCount = statusList.filter(item => item.status === 0).length;
            const inUseCount = statusList.filter(item => item.status === 1).length;
            const repairingCount = statusList.filter(item => item.status === 2).length;

            document.getElementById('idleCount').innerHTML = `空闲中 <span class="count-idle">${idleCount}</span> 台`;
            document.getElementById('inUseCount').innerHTML = `使用中 <span class="count-in-use">${inUseCount}</span> 台`;
            document.getElementById('repairingCount').innerHTML = `维修中 <span class="count-repairing">${repairingCount}</span> 台`;
        }

        async function updateIpList() {
            try {
                const response = await fetch('http://localhost:3000/status');
                const statusList = await response.json();
                const ipListBody = document.getElementById('ipListBody');
                ipListBody.innerHTML = '';

                if (statusList.length === 0) {
                    ipListBody.innerHTML = '<tr><td colspan="2" style="padding: 8px; text-align: center;">暂无 IP</td></tr>';
                    return;
                }

                statusList.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.ip}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.number}</td>
                    `;
                    ipListBody.appendChild(row);
                });
            } catch (error) {
                console.error('获取 IP 列表失败:', error);
                const ipListBody = document.getElementById('ipListBody');
                ipListBody.innerHTML = '<tr><td colspan="2" style="padding: 8px; text-align: center;">获取失败</td></tr>';
            }
        }

        async function fetchStatus() {
            try {
                const response = await fetch('http://localhost:3000/status');
                const statusList = await response.json();

                console.log('后端返回的状态:', statusList);
                const statusContainer = document.getElementById('statusContainer');
                statusContainer.innerHTML = `
                    <div class="title-bar" id="titleBar">
                        <div class="title-text" id="titleText">默认标题</div>
                        <div class="status-indicators">
                            <div class="indicator">
                                <div class="indicator-color grey"></div>
                                <span class="indicator-text" id="idleCount">空闲中 </span>
                            </div>
                            <div class="indicator">
                                <div class="indicator-color blue"></div>
                                <span class="indicator-text" id="inUseCount">使用中 </span>
                            </div>
                            <div class="indicator">
                                <div class="indicator-color red"></div>
                                <span class="indicator-text" id="repairingCount">维修中 </span>
                            </div>
                        </div>
                    </div>
                    <div class="resize-handle" id="resizeHandle"></div>
                `;

                statusList.forEach((item, index) => {
                    const block = document.createElement('div');
                    const statusClass = item.status === 1 ? 'online' : item.status === 2 ? 'repairing' : 'offline';
                    block.className = `status-block ${statusClass}`;
                    block.innerHTML = `
                        <p>${item.number}</p>
                        <div class="block-resize-handle"></div>
                    `;
                    console.log(`渲染 IP ${item.ip}: 状态 ${item.status}, 类名 ${statusClass}`);

                    block.style.left = `${item.position_x}px`;
                    block.style.top = `${item.position_y}px`;
                    block.style.width = `${item.width || 150}px`;
                    block.style.height = `${item.height || 150}px`;

                    statusContainer.appendChild(block);

                    makeDraggable(block, item.ip);
                    makeBlockResizable(block, item.ip);
                });

                updateStatusCounts(statusList);
                makeResizable();
                loadTitle();
                updateIpList();
            } catch (error) {
                console.error('获取状态失败:', error);
                const statusContainer = document.getElementById('statusContainer');
                statusContainer.innerHTML = `
                    <div class="title-bar" id="titleBar">
                        <div class="title-text" id="titleText">默认标题</div>
                        <div class="status-indicators">
                            <div class="indicator">
                                <div class="indicator-color grey"></div>
                                <span class="indicator-text" id="idleCount">空闲中 </span>
                            </div>
                            <div class="indicator">
                                <div class="indicator-color blue"></div>
                                <span class="indicator-text" id="inUseCount">使用中 </span>
                            </div>
                            <div class="indicator">
                                <div class="indicator-color red"></div>
                                <span class="indicator-text" id="repairingCount">维修中 </span>
                            </div>
                        </div>
                    </div>
                    <p>获取状态失败</p>
                    <div class="resize-handle" id="resizeHandle"></div>
                `;
                makeResizable();
                loadTitle();
                updateIpList();
            }
        }

        setInterval(fetchStatus, 30 * 1000);
        fetchStatus();
        makeResizable();
        loadBackgroundImage();
        loadTitle();
        document.addEventListener('DOMContentLoaded', () => {
            updateIpList();
        });
    </script>
</body>

</html>